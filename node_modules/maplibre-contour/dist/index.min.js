!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).mlcontour=e()}(this,(function(){"use strict";var t,e,i;function r(r,n){if(t)if(e){var s="var sharedChunk = {}; ("+t+")(sharedChunk); ("+e+")(sharedChunk);",o={};t(o),i=n(o),"undefined"!=typeof window&&(i.workerUrl=window.URL.createObjectURL(new Blob([s],{type:"text/javascript"})))}else e=n;else t=n}return r(0,(function(t){class e{constructor(t,e){this.start=t,this.end=e,this.points=[],this.append=this.append.bind(this),this.prepend=this.prepend.bind(this)}append(t,e){this.points.push(Math.round(t),Math.round(e))}prepend(t,e){this.points.splice(0,0,Math.round(t),Math.round(e))}lineString(){return this.toArray()}isEmpty(){return this.points.length<2}appendFragment(t){this.points.push(...t.points),this.end=t.end}toArray(){return this.points}}const i=[[],[[[1,2],[0,1]]],[[[2,1],[1,2]]],[[[2,1],[0,1]]],[[[1,0],[2,1]]],[[[1,2],[0,1]],[[1,0],[2,1]]],[[[1,0],[1,2]]],[[[1,0],[0,1]]],[[[0,1],[1,0]]],[[[1,2],[1,0]]],[[[0,1],[1,0]],[[2,1],[1,2]]],[[[2,1],[1,0]]],[[[0,1],[2,1]]],[[[1,2],[2,1]]],[[[0,1],[1,2]]],[]];function r(t,e,i,r){return(e=2*e+r[0])+(i=2*i+r[1])*(t+1)*2}function n(t,e,i){return(e-t)/(i-t)}function s(t,s,o=4096,a=1){if(!t)return{};const h=o/(s.width-1);let l,c,u,f,d,p;const w={},g=new Map,m=new Map;function v(t,e,i){0===t[0]?i(h*(p-1),h*(d-n(u,e,l))):2===t[0]?i(h*p,h*(d-n(f,e,c))):0===t[1]?i(h*(p-n(c,e,l)),h*(d-1)):i(h*(p-n(f,e,u)),h*d)}for(d=1-a;d<s.height+a;d++){c=s.get(0,d-1),f=s.get(0,d);let n=Math.min(c,f),o=Math.max(c,f);for(p=1-a;p<s.width+a;p++){l=c,u=f,c=s.get(p,d-1),f=s.get(p,d);const a=n,h=o;if(n=Math.min(c,f),o=Math.max(c,f),isNaN(l)||isNaN(c)||isNaN(f)||isNaN(u))continue;const b=Math.min(a,n),y=Math.max(h,o),F=Math.ceil(b/t)*t,x=Math.floor(y/t)*t;for(let n=F;n<=x;n+=t){const t=l>n,o=c>n,a=u>n,h=f>n;for(const l of i[(t?8:0)|(o?4:0)|(h?2:0)|(a?1:0)]){let t=g.get(n);t||g.set(n,t=new Map);let i=m.get(n);i||m.set(n,i=new Map);const o=l[0],a=l[1],h=r(s.width,p,d,o),c=r(s.width,p,d,a);let u,f;if(u=i.get(h))if(i.delete(h),f=t.get(c))if(t.delete(c),u===f){if(v(a,n,u.append),!u.isEmpty()){let t=w[n];t||(w[n]=t=[]),t.push(u.lineString())}}else u.appendFragment(f),i.set(u.end=f.end,u);else v(a,n,u.append),i.set(u.end=c,u);else if(u=t.get(c))t.delete(c),v(o,n,u.prepend),t.set(u.start=h,u);else{const r=new e(h,c);v(o,n,r.append),v(a,n,r.append),t.set(h,r),i.set(c,r)}}}}}for(const[t,e]of g.entries()){let i=null;for(const r of e.values())r.isEmpty()||(null==i&&(i=w[t]||(w[t]=[])),i.push(r.lineString()))}return w}let o=0;class a{constructor(t=100){this.size=()=>this.items.size,this.get=(t,e)=>this.getCancelable(t,(t=>({value:e(t),cancel:()=>{}}))).value,this.getCancelable=(t,e)=>{let i=this.items.get(t);if(i)i.lastUsed=++o,i.waiting++;else{const r=e(t);i={cancel:r.cancel,item:r.value,lastUsed:++o,waiting:1},this.items.set(t,i),this.prune()}const r=this.items,n=i.item.then((t=>t),(e=>(r.delete(t),Promise.reject(e))));let s=!1;return{value:n,cancel:()=>{i&&i.cancel&&!s&&(s=!0,--i.waiting<=0&&(i.cancel(),r.delete(t)))}}},this.clear=()=>this.items.clear(),this.maxSize=t,this.items=new Map}prune(){if(this.items.size>this.maxSize){let t,e=1/0;this.items.forEach(((i,r)=>{i.lastUsed<e&&(e=i.lastUsed,t=r)})),void 0!==t&&this.items.delete(t)}}}function h(t){const e=Object.entries(t);return e.sort((([t],[e])=>t<e?-1:t>e?1:0)),e}function l(t){return h(t).map((([t,e])=>[t,..."number"==typeof e?[e]:e].join("*"))).join("~")}function c(t){return h(t).map((([t,e])=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`)).join(",")}function u({cancel:t,value:e},i){return{cancel:t,value:e.then(i)}}let f,d,p,w,g=null;function m(t,{value:e,cancel:i}){let r=()=>{};const n=setTimeout((()=>{i(),r(new Error("timed out"))}),t),s=new Promise(((t,e)=>{r=e}));return{value:Promise.race([s,(async()=>{try{return await e}finally{clearTimeout(n)}})()]),cancel:()=>{clearTimeout(n),i()}}}const v=(null==g&&(g="undefined"!=typeof OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&"function"==typeof createImageBitmap),g?function(t,e){let i=!1;return{value:createImageBitmap(t).then((t=>i?null:(f||(f=new OffscreenCanvas(t.width,t.height),d=f.getContext("2d",{willReadFrequently:!0})),b(t,e,f,d)))),cancel:()=>{i=!0}}}:"undefined"!=typeof WorkerGlobalScope&&"undefined"!=typeof self&&self instanceof WorkerGlobalScope?function(t,e){return self.actor.send("decodeImage",[],void 0,t,e)}:function(t,e){p||(p=document.createElement("canvas"),w=p.getContext("2d",{willReadFrequently:!0}));let i=!1;const r=new Image;return{value:new Promise(((e,n)=>{r.onload=()=>{i||e(r),URL.revokeObjectURL(r.src),r.onload=null},r.onerror=()=>n(new Error("Could not load image.")),r.src=t.size?URL.createObjectURL(t):""})).then((t=>b(t,e,p,w))),cancel:()=>{i=!0,r.src=""}}});function b(t,e,i,r){if(i.width=t.width,i.height=t.height,!r)throw new Error("failed to get context");r.drawImage(t,0,0,t.width,t.height);const n=r.getImageData(0,0,t.width,t.height).data;return y(t.width,t.height,e,n)}function y(t,e,i,r){const n="mapbox"===i?(t,e,i)=>.1*(256*t*256+256*e+i)-1e4:(t,e,i)=>256*t+e+i/256-32768,s=new Float32Array(t*e);for(let t=0;t<r.length;t+=4)s[t/4]=n(r[t],r[t+1],r[t+2]);return{width:t,height:e,data:s}}class F{constructor(t,e,i){this.split=(t,e,i)=>{if(0===t)return this;const r=1<<t,n=e*this.width/r,s=i*this.height/r;return new F(this.width/r,this.height/r,((t,e)=>this.get(t+n,e+s)))},this.subsamplePixelCenters=t=>{const e=(t,e,i)=>isNaN(t)?e:isNaN(e)?t:t+(e-t)*i;if(t<=1)return this;const i=.5-1/(2*t);return new F(this.width*t,this.height*t,((r,n)=>{const s=r/t-i,o=n/t-i,a=Math.floor(s),h=Math.floor(o),l=this.get(a,h),c=this.get(a+1,h),u=this.get(a,h+1),f=this.get(a+1,h+1),d=s-a,p=o-h,w=e(l,c,d),g=e(u,f,d);return e(w,g,p)}))},this.averagePixelCentersToGrid=(t=1)=>new F(this.width+1,this.height+1,((e,i)=>{let r=0,n=0,s=0;for(let o=e-t;o<e+t;o++)for(let e=i-t;e<i+t;e++)isNaN(s=this.get(o,e))||(n++,r+=s);return 0===n?NaN:r/n})),this.scaleElevation=t=>1===t?this:new F(this.width,this.height,((e,i)=>this.get(e,i)*t)),this.materialize=(t=2)=>{const e=this.width+2*t,i=new Float32Array(e*(this.height+2*t));let r=0;for(let e=-t;e<this.height+t;e++)for(let n=-t;n<this.width+t;n++)i[r++]=this.get(n,e);return new F(this.width,this.height,((r,n)=>i[(n+t)*e+r+t]))},this.get=i,this.width=t,this.height=e}static fromRawDem(t){return new F(t.width,t.height,((e,i)=>{const r=t.data[i*t.width+e];return n=r,!isNaN(n)&&n>=-12e3&&n<=9e3?r:NaN;var n}))}static combineNeighbors(t){if(9!==t.length)throw new Error("Must include a tile plus 8 neighbors");const e=t[4];if(!e)return;const i=e.width,r=e.height;return new F(i,r,((e,n)=>{let s=0;n<0?n+=r:n<r?s+=3:(n-=r,s+=6),e<0?e+=i:e<i?s+=1:(e-=i,s+=2);const o=t[s];return o?o.get(e,n):NaN}))}}function x(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var M={
/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */
read:function(t,e,i,r,n){var s,o,a=8*n-r-1,h=(1<<a)-1,l=h>>1,c=-7,u=i?n-1:0,f=i?-1:1,d=t[e+u];for(u+=f,s=d&(1<<-c)-1,d>>=-c,c+=a;c>0;s=256*s+t[e+u],u+=f,c-=8);for(o=s&(1<<-c)-1,s>>=-c,c+=r;c>0;o=256*o+t[e+u],u+=f,c-=8);if(0===s)s=1-l;else{if(s===h)return o?NaN:1/0*(d?-1:1);o+=Math.pow(2,r),s-=l}return(d?-1:1)*o*Math.pow(2,s-r)},write:function(t,e,i,r,n,s){var o,a,h,l=8*s-n-1,c=(1<<l)-1,u=c>>1,f=23===n?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:s-1,p=r?1:-1,w=e<0||0===e&&1/e<0?1:0;for(e=Math.abs(e),isNaN(e)||e===1/0?(a=isNaN(e)?1:0,o=c):(o=Math.floor(Math.log(e)/Math.LN2),e*(h=Math.pow(2,-o))<1&&(o--,h*=2),(e+=o+u>=1?f/h:f*Math.pow(2,1-u))*h>=2&&(o++,h/=2),o+u>=c?(a=0,o=c):o+u>=1?(a=(e*h-1)*Math.pow(2,n),o+=u):(a=e*Math.pow(2,u-1)*Math.pow(2,n),o=0));n>=8;t[i+d]=255&a,d+=p,a/=256,n-=8);for(o=o<<n|a,l+=n;l>0;t[i+d]=255&o,d+=p,o/=256,l-=8);t[i+d-p]|=128*w}},P=T,k=M;function T(t){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(t)?t:new Uint8Array(t||0),this.pos=0,this.type=0,this.length=this.buf.length}T.Varint=0,T.Fixed64=1,T.Bytes=2,T.Fixed32=5;var N=4294967296,S=1/N,B="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function V(t){return t.type===T.Bytes?t.readVarint()+t.pos:t.pos+1}function C(t,e,i){return i?4294967296*e+(t>>>0):4294967296*(e>>>0)+(t>>>0)}function U(t,e,i){var r=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(r);for(var n=i.pos-1;n>=t;n--)i.buf[n+r]=i.buf[n]}function I(t,e){for(var i=0;i<t.length;i++)e.writeVarint(t[i])}function O(t,e){for(var i=0;i<t.length;i++)e.writeSVarint(t[i])}function D(t,e){for(var i=0;i<t.length;i++)e.writeFloat(t[i])}function E(t,e){for(var i=0;i<t.length;i++)e.writeDouble(t[i])}function A(t,e){for(var i=0;i<t.length;i++)e.writeBoolean(t[i])}function z(t,e){for(var i=0;i<t.length;i++)e.writeFixed32(t[i])}function L(t,e){for(var i=0;i<t.length;i++)e.writeSFixed32(t[i])}function R(t,e){for(var i=0;i<t.length;i++)e.writeFixed64(t[i])}function $(t,e){for(var i=0;i<t.length;i++)e.writeSFixed64(t[i])}function j(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+16777216*t[e+3]}function G(t,e,i){t[i]=e,t[i+1]=e>>>8,t[i+2]=e>>>16,t[i+3]=e>>>24}function W(t,e){return(t[e]|t[e+1]<<8|t[e+2]<<16)+(t[e+3]<<24)}T.prototype={destroy:function(){this.buf=null},readFields:function(t,e,i){for(i=i||this.length;this.pos<i;){var r=this.readVarint(),n=r>>3,s=this.pos;this.type=7&r,t(n,e,this),this.pos===s&&this.skip(r)}return e},readMessage:function(t,e){return this.readFields(t,e,this.readVarint()+this.pos)},readFixed32:function(){var t=j(this.buf,this.pos);return this.pos+=4,t},readSFixed32:function(){var t=W(this.buf,this.pos);return this.pos+=4,t},readFixed64:function(){var t=j(this.buf,this.pos)+j(this.buf,this.pos+4)*N;return this.pos+=8,t},readSFixed64:function(){var t=j(this.buf,this.pos)+W(this.buf,this.pos+4)*N;return this.pos+=8,t},readFloat:function(){var t=k.read(this.buf,this.pos,!0,23,4);return this.pos+=4,t},readDouble:function(){var t=k.read(this.buf,this.pos,!0,52,8);return this.pos+=8,t},readVarint:function(t){var e,i,r=this.buf;return e=127&(i=r[this.pos++]),i<128?e:(e|=(127&(i=r[this.pos++]))<<7,i<128?e:(e|=(127&(i=r[this.pos++]))<<14,i<128?e:(e|=(127&(i=r[this.pos++]))<<21,i<128?e:function(t,e,i){var r,n,s=i.buf;if(n=s[i.pos++],r=(112&n)>>4,n<128)return C(t,r,e);if(n=s[i.pos++],r|=(127&n)<<3,n<128)return C(t,r,e);if(n=s[i.pos++],r|=(127&n)<<10,n<128)return C(t,r,e);if(n=s[i.pos++],r|=(127&n)<<17,n<128)return C(t,r,e);if(n=s[i.pos++],r|=(127&n)<<24,n<128)return C(t,r,e);if(n=s[i.pos++],r|=(1&n)<<31,n<128)return C(t,r,e);throw new Error("Expected varint not more than 10 bytes")}(e|=(15&(i=r[this.pos]))<<28,t,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var t=this.readVarint();return t%2==1?(t+1)/-2:t/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var t=this.readVarint()+this.pos,e=this.pos;return this.pos=t,t-e>=12&&B?function(t,e,i){return B.decode(t.subarray(e,i))}(this.buf,e,t):function(t,e,i){var r="",n=e;for(;n<i;){var s,o,a,h=t[n],l=null,c=h>239?4:h>223?3:h>191?2:1;if(n+c>i)break;1===c?h<128&&(l=h):2===c?128==(192&(s=t[n+1]))&&(l=(31&h)<<6|63&s)<=127&&(l=null):3===c?(s=t[n+1],o=t[n+2],128==(192&s)&&128==(192&o)&&((l=(15&h)<<12|(63&s)<<6|63&o)<=2047||l>=55296&&l<=57343)&&(l=null)):4===c&&(s=t[n+1],o=t[n+2],a=t[n+3],128==(192&s)&&128==(192&o)&&128==(192&a)&&((l=(15&h)<<18|(63&s)<<12|(63&o)<<6|63&a)<=65535||l>=1114112)&&(l=null)),null===l?(l=65533,c=1):l>65535&&(l-=65536,r+=String.fromCharCode(l>>>10&1023|55296),l=56320|1023&l),r+=String.fromCharCode(l),n+=c}return r}(this.buf,e,t)},readBytes:function(){var t=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,t);return this.pos=t,e},readPackedVarint:function(t,e){if(this.type!==T.Bytes)return t.push(this.readVarint(e));var i=V(this);for(t=t||[];this.pos<i;)t.push(this.readVarint(e));return t},readPackedSVarint:function(t){if(this.type!==T.Bytes)return t.push(this.readSVarint());var e=V(this);for(t=t||[];this.pos<e;)t.push(this.readSVarint());return t},readPackedBoolean:function(t){if(this.type!==T.Bytes)return t.push(this.readBoolean());var e=V(this);for(t=t||[];this.pos<e;)t.push(this.readBoolean());return t},readPackedFloat:function(t){if(this.type!==T.Bytes)return t.push(this.readFloat());var e=V(this);for(t=t||[];this.pos<e;)t.push(this.readFloat());return t},readPackedDouble:function(t){if(this.type!==T.Bytes)return t.push(this.readDouble());var e=V(this);for(t=t||[];this.pos<e;)t.push(this.readDouble());return t},readPackedFixed32:function(t){if(this.type!==T.Bytes)return t.push(this.readFixed32());var e=V(this);for(t=t||[];this.pos<e;)t.push(this.readFixed32());return t},readPackedSFixed32:function(t){if(this.type!==T.Bytes)return t.push(this.readSFixed32());var e=V(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed32());return t},readPackedFixed64:function(t){if(this.type!==T.Bytes)return t.push(this.readFixed64());var e=V(this);for(t=t||[];this.pos<e;)t.push(this.readFixed64());return t},readPackedSFixed64:function(t){if(this.type!==T.Bytes)return t.push(this.readSFixed64());var e=V(this);for(t=t||[];this.pos<e;)t.push(this.readSFixed64());return t},skip:function(t){var e=7&t;if(e===T.Varint)for(;this.buf[this.pos++]>127;);else if(e===T.Bytes)this.pos=this.readVarint()+this.pos;else if(e===T.Fixed32)this.pos+=4;else{if(e!==T.Fixed64)throw new Error("Unimplemented type: "+e);this.pos+=8}},writeTag:function(t,e){this.writeVarint(t<<3|e)},realloc:function(t){for(var e=this.length||16;e<this.pos+t;)e*=2;if(e!==this.length){var i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.length=e}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(t){this.realloc(4),G(this.buf,t,this.pos),this.pos+=4},writeSFixed32:function(t){this.realloc(4),G(this.buf,t,this.pos),this.pos+=4},writeFixed64:function(t){this.realloc(8),G(this.buf,-1&t,this.pos),G(this.buf,Math.floor(t*S),this.pos+4),this.pos+=8},writeSFixed64:function(t){this.realloc(8),G(this.buf,-1&t,this.pos),G(this.buf,Math.floor(t*S),this.pos+4),this.pos+=8},writeVarint:function(t){(t=+t||0)>268435455||t<0?function(t,e){var i,r;t>=0?(i=t%4294967296|0,r=t/4294967296|0):(r=~(-t/4294967296),4294967295^(i=~(-t%4294967296))?i=i+1|0:(i=0,r=r+1|0));if(t>=0x10000000000000000||t<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");e.realloc(10),function(t,e,i){i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos++]=127&t|128,t>>>=7,i.buf[i.pos]=127&t}(i,0,e),function(t,e){var i=(7&t)<<4;if(e.buf[e.pos++]|=i|((t>>>=3)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;if(e.buf[e.pos++]=127&t|((t>>>=7)?128:0),!t)return;e.buf[e.pos++]=127&t}(r,e)}(t,this):(this.realloc(4),this.buf[this.pos++]=127&t|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=127&(t>>>=7)|(t>127?128:0),t<=127||(this.buf[this.pos++]=t>>>7&127))))},writeSVarint:function(t){this.writeVarint(t<0?2*-t-1:2*t)},writeBoolean:function(t){this.writeVarint(Boolean(t))},writeString:function(t){t=String(t),this.realloc(4*t.length),this.pos++;var e=this.pos;this.pos=function(t,e,i){for(var r,n,s=0;s<e.length;s++){if((r=e.charCodeAt(s))>55295&&r<57344){if(!n){r>56319||s+1===e.length?(t[i++]=239,t[i++]=191,t[i++]=189):n=r;continue}if(r<56320){t[i++]=239,t[i++]=191,t[i++]=189,n=r;continue}r=n-55296<<10|r-56320|65536,n=null}else n&&(t[i++]=239,t[i++]=191,t[i++]=189,n=null);r<128?t[i++]=r:(r<2048?t[i++]=r>>6|192:(r<65536?t[i++]=r>>12|224:(t[i++]=r>>18|240,t[i++]=r>>12&63|128),t[i++]=r>>6&63|128),t[i++]=63&r|128)}return i}(this.buf,t,this.pos);var i=this.pos-e;i>=128&&U(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i},writeFloat:function(t){this.realloc(4),k.write(this.buf,t,this.pos,!0,23,4),this.pos+=4},writeDouble:function(t){this.realloc(8),k.write(this.buf,t,this.pos,!0,52,8),this.pos+=8},writeBytes:function(t){var e=t.length;this.writeVarint(e),this.realloc(e);for(var i=0;i<e;i++)this.buf[this.pos++]=t[i]},writeRawMessage:function(t,e){this.pos++;var i=this.pos;t(e,this);var r=this.pos-i;r>=128&&U(i,r,this),this.pos=i-1,this.writeVarint(r),this.pos+=r},writeMessage:function(t,e,i){this.writeTag(t,T.Bytes),this.writeRawMessage(e,i)},writePackedVarint:function(t,e){e.length&&this.writeMessage(t,I,e)},writePackedSVarint:function(t,e){e.length&&this.writeMessage(t,O,e)},writePackedBoolean:function(t,e){e.length&&this.writeMessage(t,A,e)},writePackedFloat:function(t,e){e.length&&this.writeMessage(t,D,e)},writePackedDouble:function(t,e){e.length&&this.writeMessage(t,E,e)},writePackedFixed32:function(t,e){e.length&&this.writeMessage(t,z,e)},writePackedSFixed32:function(t,e){e.length&&this.writeMessage(t,L,e)},writePackedFixed64:function(t,e){e.length&&this.writeMessage(t,R,e)},writePackedSFixed64:function(t,e){e.length&&this.writeMessage(t,$,e)},writeBytesField:function(t,e){this.writeTag(t,T.Bytes),this.writeBytes(e)},writeFixed32Field:function(t,e){this.writeTag(t,T.Fixed32),this.writeFixed32(e)},writeSFixed32Field:function(t,e){this.writeTag(t,T.Fixed32),this.writeSFixed32(e)},writeFixed64Field:function(t,e){this.writeTag(t,T.Fixed64),this.writeFixed64(e)},writeSFixed64Field:function(t,e){this.writeTag(t,T.Fixed64),this.writeSFixed64(e)},writeVarintField:function(t,e){this.writeTag(t,T.Varint),this.writeVarint(e)},writeSVarintField:function(t,e){this.writeTag(t,T.Varint),this.writeSVarint(e)},writeStringField:function(t,e){this.writeTag(t,T.Bytes),this.writeString(e)},writeFloatField:function(t,e){this.writeTag(t,T.Fixed32),this.writeFloat(e)},writeDoubleField:function(t,e){this.writeTag(t,T.Fixed64),this.writeDouble(e)},writeBooleanField:function(t,e){this.writeVarintField(t,Boolean(e))}};var q,K=x(P);function Y(t,e){if(!e)throw new Error("pbf undefined");e.writeVarintField(15,2),e.writeStringField(1,t.id||""),e.writeVarintField(5,t.extent||4096);const i={keys:[],values:[],keycache:{},valuecache:{}};for(const r of t.features)i.feature=r,e.writeMessage(2,H,i);for(const t of i.keys)e.writeStringField(3,t);for(const t of i.values)e.writeMessage(4,X,t)}function H(t,e){const i=t.feature;if(!i||!e)throw new Error;e.writeMessage(2,J,t),e.writeVarintField(3,i.type),e.writeMessage(4,Q,i)}function J(t,e){const i=t.feature;if(!i||!e)throw new Error;const r=t.keys,n=t.values,s=t.keycache,o=t.valuecache;for(const t in i.properties){let a=i.properties[t],h=s[t];if(null===a)continue;void 0===h&&(r.push(t),h=r.length-1,s[t]=h),e.writeVarint(h);const l=typeof a;"string"!==l&&"boolean"!==l&&"number"!==l&&(a=JSON.stringify(a));const c=`${l}:${a}`;let u=o[c];void 0===u&&(n.push(a),u=n.length-1,o[c]=u),e.writeVarint(u)}}function _(t,e){return(e<<3)+(7&t)}function Z(t){return t<<1^t>>31}function Q(t,e){if(!e)throw new Error;const i=t.geometry,r=t.type;let n=0,s=0;for(const t of i){let i=1;r===q.POINT&&(i=t.length/2),e.writeVarint(_(1,i));const o=t.length/2,a=r===q.POLYGON?o-1:o;for(let i=0;i<a;i++){1===i&&1!==r&&e.writeVarint(_(2,a-1));const o=t[2*i]-n,h=t[2*i+1]-s;e.writeVarint(Z(o)),e.writeVarint(Z(h)),n+=o,s+=h}r===q.POLYGON&&e.writeVarint(_(7,1))}}function X(t,e){if(!e)throw new Error;"string"==typeof t?e.writeStringField(1,t):"boolean"==typeof t?e.writeBooleanField(7,t):"number"==typeof t&&(t%1!=0?e.writeDoubleField(3,t):t<0?e.writeSVarintField(6,t):e.writeVarintField(5,t))}!function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.POINT=1]="POINT",t[t.LINESTRING=2]="LINESTRING",t[t.POLYGON=3]="POLYGON"}(q||(q={}));const tt="undefined"!=typeof performance?performance:void 0,et=tt?tt.timeOrigin||(new Date).getTime()-tt.now():(new Date).getTime();function it(t){var e;return JSON.parse(JSON.stringify((null===(e=null==tt?void 0:tt.getEntriesByName)||void 0===e?void 0:e.call(tt,t))||[]))}function rt(){return tt?tt.now():(new Date).getTime()}function nt(t){const e=[];for(const i of t)e.push(...i);return e}class st{constructor(t){this.marks={},this.urls=[],this.fetched=[],this.resources=[],this.tilesFetched=0,this.timeOrigin=et,this.finish=t=>{this.markFinish();const e=t=>{const e=this.marks[t]||[],i=Math.max(...e.map((t=>Math.max(...t)))),r=Math.min(...e.map((t=>Math.min(...t))));return Number.isFinite(i)?i-r:void 0},i=e("main")||0,r=e("fetch"),n=e("decode"),s=e("isoline");return{url:t,tilesUsed:this.tilesFetched,origin:this.timeOrigin,marks:this.marks,resources:[...this.resources,...nt(this.fetched.map(it))],duration:i,fetch:r,decode:n,process:s,wait:i-(r||0)-(n||0)-(s||0)}},this.error=t=>({...this.finish(t),error:!0}),this.marker=t=>{var e;this.marks[t]||(this.marks[t]=[]);const i=[rt()];return null===(e=this.marks[t])||void 0===e||e.push(i),()=>i.push(rt())},this.useTile=t=>{this.urls.indexOf(t)<0&&(this.urls.push(t),this.tilesFetched++)},this.fetchTile=t=>{this.fetched.indexOf(t)<0&&this.fetched.push(t)},this.addAll=t=>{var e;this.tilesFetched+=t.tilesUsed;const i=t.origin-this.timeOrigin;for(const r in t.marks){const n=r;(this.marks[n]||(this.marks[n]=[])).push(...(null===(e=t.marks[n])||void 0===e?void 0:e.map((t=>t.map((t=>t+i)))))||[])}this.resources.push(...t.resources.map((t=>function(t,e){const i={};for(const r in t)0!==t[r]&&ot.test(r)?i[r]=Number(t[r])+e:i[r]=t[r];return i}(t,i))))},this.markFinish=this.marker(t)}}const ot=/(Start$|End$|^start|^end)/;let at=0;t.Actor=class{constructor(t,e,i=2e4){this.callbacks={},this.cancels={},this.dest=t,this.timeoutMs=i,this.dest.onmessage=async({data:t})=>{const i=t;if("cancel"===i.type){const t=this.cancels[i.id];delete this.cancels[i.id],t&&t()}else if("response"===i.type){const t=this.callbacks[i.id];delete this.callbacks[i.id],t&&t(i.error?new Error(i.error):void 0,i.response,i.timings)}else if("request"===i.type){const t=new st("worker"),r=e[i.name],n=r.apply(r,[...i.args,t]),s=`${i.name}_${i.id}`;if(i.id&&n){this.cancels[i.id]=n.cancel;try{const e=await n.value,r=null==e?void 0:e.transferrables;this.postMessage({id:i.id,type:"response",response:e,timings:t.finish(s)},r)}catch(e){this.postMessage({id:i.id,type:"response",error:(null==e?void 0:e.toString())||"error",timings:t.finish(s)})}delete this.cancels[i.id]}}}}postMessage(t,e){this.dest.postMessage(t,e||[])}send(t,e,i,...r){const n=++at,s=new Promise(((s,o)=>{this.postMessage({id:n,type:"request",name:t,args:r},e),this.callbacks[n]=(t,e,r)=>{null==i||i.addAll(r),t?o(t):s(e)}}));return m(this.timeoutMs,{value:s,cancel:()=>{delete this.callbacks[n],this.postMessage({id:n,type:"cancel"})}})}},t.HeightTile=F,t.LocalDemManager=class{constructor(t,e,i,r,n){this.loaded=Promise.resolve(),this.decodeImage=v,this.fetchAndParseTile=(t,e,i,r)=>{const n=this,s=this.demUrlPattern.replace("{z}",t.toString()).replace("{x}",e.toString()).replace("{y}",i.toString());return null==r||r.useTile(s),this.parsedCache.getCancelable(s,(()=>{const s=n.fetchTile(t,e,i,r);let o=!1,a=()=>{};return{value:s.value.then((async t=>{if(o)throw new Error("canceled");const e=n.decodeImage(t.data,n.encoding);a=e.cancel;const i=null==r?void 0:r.marker("decode"),s=await e.value;return null==i||i(),s})),cancel:()=>{o=!0,a(),s.cancel()}}}))},this.tileCache=new a(e),this.parsedCache=new a(e),this.contourCache=new a(e),this.timeoutMs=n,this.demUrlPattern=t,this.encoding=i,this.maxzoom=r}fetchTile(t,e,i,r){const n=this.demUrlPattern.replace("{z}",t.toString()).replace("{x}",e.toString()).replace("{y}",i.toString());return null==r||r.useTile(n),this.tileCache.getCancelable(n,(()=>{let t=()=>{};const e={};try{const i=new AbortController;e.signal=i.signal,t=()=>i.abort()}catch(t){}null==r||r.fetchTile(n);const i=null==r?void 0:r.marker("fetch");return m(this.timeoutMs,{value:fetch(n,e).then((async t=>{if(null==i||i(),!t.ok)throw new Error(`Bad response: ${t.status} for ${n}`);return{data:await t.blob(),expires:t.headers.get("expires")||void 0,cacheControl:t.headers.get("cache-control")||void 0}})),cancel:t})}))}fetchDem(t,e,i,r,n){const s=Math.min(t-(r.overzoom||0),this.maxzoom),o=t-s,a=1<<o,h=Math.floor(e/a),l=Math.floor(i/a),{value:c,cancel:u}=this.fetchAndParseTile(s,h,l,n),f=e%a,d=i%a;return{value:c.then((t=>F.fromRawDem(t).split(o,f,d))),cancel:u}}fetchContourTile(t,e,i,r,n){const{levels:o,multiplier:a=1,buffer:h=1,extent:l=4096,contourLayer:u="contours",elevationKey:f="ele",levelKey:d="level",subsampleBelow:p=100}=r;if(!o||0===o.length)return{cancel(){},value:Promise.resolve({arrayBuffer:new ArrayBuffer(0)})};const w=[t,e,i,c(r)].join("/");return this.contourCache.getCancelable(w,(()=>{const c=1<<t;let w=!1;const g=[];for(let s=i-1;s<=i+1;s++)for(let i=e-1;i<=e+1;i++)g.push(s<0||s>=c?null:this.fetchDem(t,(i+c)%c,s,r,n));const m=Promise.all(g.map((t=>null==t?void 0:t.value))).then((async t=>{let e=F.combineNeighbors(t);if(!e||w)return{arrayBuffer:(new Uint8Array).buffer};const i=null==n?void 0:n.marker("isoline");if(e.width>=p)e=e.materialize(2);else for(;e.width<p;)e=e.subsamplePixelCenters(2).materialize(2);e=e.averagePixelCentersToGrid().scaleElevation(a).materialize(1);const r=s(o[0],e,l,h);null==i||i();const c=function(t){const e=new K;for(const i in t.layers){const r=t.layers[i];r.extent||(r.extent=t.extent),e.writeMessage(3,Y,{...r,id:i})}return e.finish()}({extent:l,layers:{[u]:{features:Object.entries(r).map((([t,e])=>{const i=Number(t);return{type:q.LINESTRING,geometry:e,properties:{[f]:i,[d]:Math.max(...o.map(((t,e)=>i%t==0?e:0)))}}}))}}});return null==i||i(),{arrayBuffer:c.buffer}}));return{value:m,cancel(){w=!0,g.forEach((t=>t&&t.cancel()))}}}))}},t.Timer=st,t.decodeOptions=function(t){return Object.fromEntries(t.replace(/^.*\?/,"").split("&").map((t=>{const e=t.split("=").map(decodeURIComponent),i=e[0];let r=e[1];switch(i){case"thresholds":n=r,r=Object.fromEntries(n.split("~").map((t=>t.split("*").map(Number))).map((([t,...e])=>[t,e])));break;case"extent":case"multiplier":case"overzoom":case"buffer":r=Number(r)}var n;return[i,r]})))},t.decodeParsedImage=y,t.defaultDecoder=v,t.encodeOptions=function({thresholds:t,...e}){return h({thresholds:l(t),...e}).map((([t,e])=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`)).join("&")},t.generateIsolines=s,t.getOptionsForZoom=function(t,e){const{thresholds:i,...r}=t;let n=[],s=-1/0;return Object.entries(i).forEach((([t,i])=>{const r=Number(t);r<=e&&r>s&&(s=r,n="number"==typeof i?[i]:i)})),{levels:n,...r}},t.prepareContourTile=function(t){return u(t,(({arrayBuffer:t})=>{const e=function(t){const e=new ArrayBuffer(t.byteLength);return new Uint8Array(e).set(new Uint8Array(t)),e}(t);return{arrayBuffer:e,transferrables:[e]}}))},t.prepareDemTile=function(t,e){return u(t,(({data:t,...i})=>{let r=t;return e&&(r=new Float32Array(t.length),r.set(t)),{...i,data:r,transferrables:[r.buffer]}}))}})),r(0,(function(t){const e=t=>({cancel(){},value:Promise.reject(new Error(`No manager registered for ${t}`))});const i="undefined"!=typeof self?self:"undefined"!=typeof window?window:global;i.actor=new t.Actor(i,new class{constructor(){this.managers={},this.init=e=>(this.managers[e.managerId]=new t.LocalDemManager(e.demUrlPattern,e.cacheSize,e.encoding,e.maxzoom,e.timeoutMs),{cancel(){},value:Promise.resolve()}),this.fetchTile=(t,i,r,n,s)=>{var o;return(null===(o=this.managers[t])||void 0===o?void 0:o.fetchTile(i,r,n,s))||e(t)},this.fetchAndParseTile=(i,r,n,s,o)=>{var a;return t.prepareDemTile((null===(a=this.managers[i])||void 0===a?void 0:a.fetchAndParseTile(r,n,s,o))||e(i),!0)},this.fetchContourTile=(i,r,n,s,o,a)=>{var h;return t.prepareContourTile((null===(h=this.managers[i])||void 0===h?void 0:h.fetchContourTile(r,n,s,o,a))||e(i))}}})})),r(0,(function(t){const e={workerUrl:""};let i,r=0;class n{constructor(){this.decodeImage=(e,i)=>t.prepareDemTile(t.defaultDecoder(e,i),!1)}}function s(){if(!i){const r=new Worker(e.workerUrl),s=new n;i=new t.Actor(r,s)}return i}class o{constructor(t,e,i,n,o,a){this.fetchTile=(t,e,i,r)=>this.actor.send("fetchTile",[],r,this.managerId,t,e,i),this.fetchAndParseTile=(t,e,i,r)=>this.actor.send("fetchAndParseTile",[],r,this.managerId,t,e,i),this.fetchContourTile=(t,e,i,r,n)=>this.actor.send("fetchContourTile",[],n,this.managerId,t,e,i,r);const h=this.managerId=++r;this.actor=a||s(),this.loaded=this.actor.send("init",[],void 0,{cacheSize:e,demUrlPattern:t,encoding:i,maxzoom:n,managerId:h,timeoutMs:o}).value}}Blob.prototype.arrayBuffer||(Blob.prototype.arrayBuffer=function(){return new Promise(((t,e)=>{const i=new FileReader;i.onload=e=>{var i;return t(null===(i=e.target)||void 0===i?void 0:i.result)},i.onerror=e,i.readAsArrayBuffer(this)}))});const a=new Set;const h={generateIsolines:t.generateIsolines,DemSource:class{constructor({url:e,cacheSize:i=100,id:r="dem",encoding:n="terrarium",maxzoom:s=12,worker:h=!0,timeoutMs:l=1e4,actor:c}){this.timingCallbacks=[],this.onTiming=t=>{this.timingCallbacks.push(t)},this.setupMaplibre=t=>{t.addProtocol(this.sharedDemProtocolId,this.sharedDemProtocol),t.addProtocol(this.contourProtocolId,this.contourProtocol)},this.sharedDemProtocol=(e,i)=>{const[r,n,s]=this.parseUrl(e.url),o=new t.Timer("main"),a=this.manager.fetchTile(r,n,s,o);let h=!1;return(async()=>{let t;try{const r=await a.value;if(t=o.finish(e.url),h)return;const n=await r.data.arrayBuffer();if(h)return;i(void 0,n,r.cacheControl,r.expires)}catch(r){if(t=o.error(e.url),h)return;i(r)}this.timingCallbacks.forEach((e=>e(t)))})(),{cancel:()=>{h=!1,a.cancel()}}},this.contourProtocol=(e,i)=>{const r=new t.Timer("main"),[n,s,o]=this.parseUrl(e.url),a=t.decodeOptions(e.url),h=this.manager.fetchContourTile(n,s,o,t.getOptionsForZoom(a,n),r);let l=!1;return(async()=>{let t;try{const n=await h.value;if(t=r.finish(e.url),l)return;i(void 0,n.arrayBuffer)}catch(n){if(l)return;t=r.error(e.url),i(n)}this.timingCallbacks.forEach((e=>e(t)))})(),{cancel:()=>{l=!0,h.cancel()}}},this.contourProtocolUrl=e=>`${this.contourProtocolUrlBase}?${t.encodeOptions(e)}`;let u=r,f=1;for(;a.has(u);)u=r+f++;a.add(u),this.sharedDemProtocolId=`${u}-shared`,this.contourProtocolId=`${u}-contour`,this.sharedDemProtocolUrl=`${this.sharedDemProtocolId}://{z}/{x}/{y}`,this.contourProtocolUrlBase=`${this.contourProtocolId}://{z}/{x}/{y}`;const d=h?o:t.LocalDemManager;this.manager=new d(e,i,n,s,l,c)}getDemTile(t,e,i){return this.manager.fetchAndParseTile(t,e,i).value}parseUrl(t){const[,e,i,r]=/\/\/(\d+)\/(\d+)\/(\d+)/.exec(t)||[];return[Number(e),Number(i),Number(r)]}},HeightTile:t.HeightTile,LocalDemManager:t.LocalDemManager,decodeParsedImage:t.decodeParsedImage,set workerUrl(t){e.workerUrl=t},get workerUrl(){return e.workerUrl}};return h})),i}));
